name: Cargo.lock Updater

# This workflow fixes version mismatches between Cargo.toml and Cargo.lock
# Specifically targets wasm-bindgen to ensure exact version matching
# Works on any branch - select target branch when running

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to update (e.g., beta, alpha, master)'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - alpha
          - master
      package:
        description: 'Package to update'
        required: false
        default: 'wasm-bindgen'
        type: string
      version:
        description: 'Target version'
        required: false
        default: '0.2.105'
        type: string

jobs:
  update-cargo-lock:
    runs-on: ubuntu-latest
    environment: cf
    
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-update-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-update-
      
      - name: Update wasm-bindgen dependencies to exact version
        run: |
          echo "ðŸ“¦ Updating ${{ inputs.package }} to version ${{ inputs.version }} on branch ${{ inputs.target_branch }}"
          
          # Update main wasm-bindgen package - this will update sub-packages automatically
          cargo update -p wasm-bindgen --precise ${{ inputs.version }}
          
          # Try to update sub-packages if they still exist as separate packages
          # Use || true to continue if package doesn't exist
          cargo update -p wasm-bindgen-macro --precise ${{ inputs.version }} || echo "wasm-bindgen-macro: already updated or not found"
          cargo update -p wasm-bindgen-shared --precise ${{ inputs.version }} || echo "wasm-bindgen-shared: already updated or not found"
          cargo update -p wasm-bindgen-macro-support --precise ${{ inputs.version }} || echo "wasm-bindgen-macro-support: already updated or not found"
          
          echo "âœ… Cargo.lock updated successfully"
      
      - name: Verify wasm-bindgen version in Cargo.lock
        run: |
          echo "ðŸ” Verifying wasm-bindgen version in Cargo.lock..."
          
          WASM_BINDGEN_VERSION=$(grep -A 3 '\[\[package\]\]' Cargo.lock | grep -A 3 'name = "wasm-bindgen"' | grep 'version' | head -1 | cut -d'"' -f2)
          
          echo "Found wasm-bindgen version: $WASM_BINDGEN_VERSION"
          
          if [ "$WASM_BINDGEN_VERSION" = "${{ inputs.version }}" ]; then
            echo "âœ… Version match confirmed: $WASM_BINDGEN_VERSION"
          else
            echo "âŒ Version mismatch detected!"
            echo "Expected: ${{ inputs.version }}"
            echo "Found: $WASM_BINDGEN_VERSION"
            exit 1
          fi
      
      - name: Show updated packages summary
        run: |
          echo "ðŸ“Š Summary of changes:"
          git diff Cargo.lock | grep -E '^[+-].*version = ' | head -20 || echo "No version changes in first 20 lines"
      
      - name: Test build compatibility
        run: |
          echo "ðŸ”¨ Testing build with updated dependencies..."
          cargo check --target wasm32-unknown-unknown --release
          echo "âœ… Build check passed"
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --exit-code Cargo.lock; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes detected in Cargo.lock"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in Cargo.lock"
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(deps): sync Cargo.lock wasm-bindgen to ${{ inputs.version }}"
          title: "ðŸ”§ Fix: Sync wasm-bindgen to ${{ inputs.version }} in Cargo.lock [${{ inputs.target_branch }}]"
          body: |
            ## ðŸ”§ Cargo.lock Version Sync
            
            **Target Branch:** `${{ inputs.target_branch }}`
            
            ### Issue
            Fixed critical version mismatch between Cargo.toml and Cargo.lock for `${{ inputs.package }}`.
            
            ### Changes
            - Updated `wasm-bindgen` to version **${{ inputs.version }}** in Cargo.lock
            - Updated all wasm-bindgen sub-packages for consistency
            - Verified build compatibility with wasm32-unknown-unknown target
            
            ### Additional Updates
            The cargo update also brought in compatible updates for:
            - `worker` crate dependencies
            - Related wasm ecosystem packages
            - Minor version bumps for compatibility
            
            ### Why This Matters
            wasm-bindgen requires **exact version matching** between:
            - The Rust library version (in Cargo.lock)
            - The CLI tool version (in build workflow)
            
            Mismatches cause build failures with errors like:
            ```
            error: rust wasm file schema version: X.X.X
                  this binary schema version: Y.Y.Y
            ```
            
            ### Verification
            - âœ… Cargo.lock updated to ${{ inputs.version }}
            - âœ… Build check passed for wasm32-unknown-unknown
            - âœ… All wasm-bindgen sub-packages synchronized
            
            ### Next Steps
            1. Review the Cargo.lock diff below
            2. Merge this PR to fix the version mismatch
            3. Ensure `.github/workflows/cf.yml` uses matching wasm-bindgen-cli version
            4. Deploy to ${{ inputs.target_branch }} for testing
            
            ---
            *Auto-generated by updater.yml workflow*  
            *Triggered by: @${{ github.actor }}*  
            *Branch: ${{ inputs.target_branch }}*
          branch: fix/wasm-bindgen-${{ inputs.target_branch }}-${{ github.run_number }}
          base: ${{ inputs.target_branch }}
          labels: dependencies, critical, version-sync, automated
          delete-branch: true
      
      - name: Summary
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "## ðŸŽ‰ Cargo.lock Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Target Branch" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ inputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Package" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** ${{ inputs.package }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pull request created successfully" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build compatibility verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Additional Updates" >> $GITHUB_STEP_SUMMARY
          echo "Cargo also updated related dependencies for compatibility." >> $GITHUB_STEP_SUMMARY
          echo "Review the PR diff to see all changes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review and merge the PR to apply changes." >> $GITHUB_STEP_SUMMARY
      
      - name: No Changes Summary
        if: steps.changes.outputs.changed == 'false'
        run: |
          echo "## â„¹ï¸  No Update Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cargo.lock is already synchronized with the requested version." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ inputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** ${{ inputs.package }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
