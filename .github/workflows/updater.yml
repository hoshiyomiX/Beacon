name: Dependency Updater

# Updates both Cargo.toml and Cargo.lock to latest stable versions
# Creates PR with all changes for review

on:
  workflow_dispatch:
    inputs:
      update_mode:
        description: 'Update mode'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable      # Update to latest stable versions in both files
          - lockfile    # Only regenerate Cargo.lock
          - patch       # Only patch version updates

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    environment: cf
    
    steps:
      - name: Checkout beta branch
        uses: actions/checkout@v4
        with:
          ref: beta
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Install cargo-edit for version updates
        run: cargo install cargo-edit
      
      - name: Backup current files
        run: |
          cp Cargo.toml Cargo.toml.backup
          cp Cargo.lock Cargo.lock.backup
          echo "âœ… Backed up Cargo.toml and Cargo.lock"
      
      - name: Update dependencies based on mode
        run: |
          echo "ðŸ“¦ Update mode: ${{ inputs.update_mode }}"
          echo "================================"
          
          case "${{ inputs.update_mode }}" in
            stable)
              echo "ðŸ”„ Updating to latest stable versions..."
              # Update major dependencies to latest stable
              cargo upgrade --incompatible worker wasm-bindgen wasm-bindgen-futures
              # Update all other dependencies
              cargo update
              ;;
            lockfile)
              echo "ðŸ”’ Regenerating Cargo.lock only..."
              rm -f Cargo.lock
              cargo generate-lockfile
              cargo update
              ;;
            patch)
              echo "ðŸ©¹ Patch updates only..."
              cargo update
              ;;
          esac
          
          echo "âœ… Dependencies updated"
      
      - name: Extract version changes
        id: versions
        run: |
          echo "ðŸ“Š Detecting version changes..."
          
          # Get wasm-bindgen versions
          OLD_WASM_TOML=$(grep '^wasm-bindgen = ' Cargo.toml.backup | grep -oP '"\K[^"]+' || echo "N/A")
          NEW_WASM_TOML=$(grep '^wasm-bindgen = ' Cargo.toml | grep -oP '"\K[^"]+' || echo "N/A")
          OLD_WASM_LOCK=$(grep -A 3 '\[\[package\]\]' Cargo.lock.backup | grep -A 3 'name = "wasm-bindgen"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
          NEW_WASM_LOCK=$(grep -A 3 '\[\[package\]\]' Cargo.lock | grep -A 3 'name = "wasm-bindgen"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
          
          # Get worker versions
          OLD_WORKER_TOML=$(grep '^worker = ' Cargo.toml.backup | grep -oP '"\K[^"]+' || echo "N/A")
          NEW_WORKER_TOML=$(grep '^worker = ' Cargo.toml | grep -oP '"\K[^"]+' || echo "N/A")
          OLD_WORKER_LOCK=$(grep -A 3 '\[\[package\]\]' Cargo.lock.backup | grep -A 3 'name = "worker"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
          NEW_WORKER_LOCK=$(grep -A 3 '\[\[package\]\]' Cargo.lock | grep -A 3 'name = "worker"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
          
          # Get wasm-bindgen-futures versions
          OLD_WASM_FUTURES=$(grep '^wasm-bindgen-futures = ' Cargo.toml.backup | grep -oP '"\K[^"]+' || echo "N/A")
          NEW_WASM_FUTURES=$(grep '^wasm-bindgen-futures = ' Cargo.toml | grep -oP '"\K[^"]+' || echo "N/A")
          
          echo "wasm_bindgen_toml_old=$OLD_WASM_TOML" >> $GITHUB_OUTPUT
          echo "wasm_bindgen_toml_new=$NEW_WASM_TOML" >> $GITHUB_OUTPUT
          echo "wasm_bindgen_lock_old=$OLD_WASM_LOCK" >> $GITHUB_OUTPUT
          echo "wasm_bindgen_lock_new=$NEW_WASM_LOCK" >> $GITHUB_OUTPUT
          
          echo "worker_toml_old=$OLD_WORKER_TOML" >> $GITHUB_OUTPUT
          echo "worker_toml_new=$NEW_WORKER_TOML" >> $GITHUB_OUTPUT
          echo "worker_lock_old=$OLD_WORKER_LOCK" >> $GITHUB_OUTPUT
          echo "worker_lock_new=$NEW_WORKER_LOCK" >> $GITHUB_OUTPUT
          
          echo "wasm_futures_old=$OLD_WASM_FUTURES" >> $GITHUB_OUTPUT
          echo "wasm_futures_new=$NEW_WASM_FUTURES" >> $GITHUB_OUTPUT
          
          # Display summary
          echo "### Version Changes:"
          echo "wasm-bindgen (Cargo.toml): $OLD_WASM_TOML â†’ $NEW_WASM_TOML"
          echo "wasm-bindgen (Cargo.lock): $OLD_WASM_LOCK â†’ $NEW_WASM_LOCK"
          echo "worker (Cargo.toml): $OLD_WORKER_TOML â†’ $NEW_WORKER_TOML"
          echo "worker (Cargo.lock): $OLD_WORKER_LOCK â†’ $NEW_WORKER_LOCK"
          echo "wasm-bindgen-futures: $OLD_WASM_FUTURES â†’ $NEW_WASM_FUTURES"
      
      - name: Test build compatibility
        run: |
          echo "ðŸ”¨ Testing build with updated dependencies..."
          cargo check --target wasm32-unknown-unknown --release
          echo "âœ… Build check passed - all dependencies compatible"
      
      - name: Check for changes
        id: changes
        run: |
          TOML_CHANGED=false
          LOCK_CHANGED=false
          
          if ! git diff --exit-code Cargo.toml; then
            TOML_CHANGED=true
            echo "ðŸ“ Cargo.toml has changes"
          fi
          
          if ! git diff --exit-code Cargo.lock; then
            LOCK_CHANGED=true
            echo "ðŸ”’ Cargo.lock has changes"
          fi
          
          if [ "$TOML_CHANGED" = true ] || [ "$LOCK_CHANGED" = true ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Dependencies updated successfully"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes needed - dependencies already up-to-date"
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies to latest stable versions"
          title: "â¬†ï¸ Update: Latest stable dependencies [beta]"
          body: |
            ## â¬†ï¸ Dependency Updates
            
            **Target Branch:** `beta`  
            **Update Mode:** `${{ inputs.update_mode }}`
            
            ### Version Changes
            
            #### Cargo.toml
            - **wasm-bindgen**: `${{ steps.versions.outputs.wasm_bindgen_toml_old }}` â†’ `${{ steps.versions.outputs.wasm_bindgen_toml_new }}`
            - **worker**: `${{ steps.versions.outputs.worker_toml_old }}` â†’ `${{ steps.versions.outputs.worker_toml_new }}`
            - **wasm-bindgen-futures**: `${{ steps.versions.outputs.wasm_futures_old }}` â†’ `${{ steps.versions.outputs.wasm_futures_new }}`
            
            #### Cargo.lock
            - **wasm-bindgen**: `${{ steps.versions.outputs.wasm_bindgen_lock_old }}` â†’ `${{ steps.versions.outputs.wasm_bindgen_lock_new }}`
            - **worker**: `${{ steps.versions.outputs.worker_lock_old }}` â†’ `${{ steps.versions.outputs.worker_lock_new }}`
            
            ### Verification
            - âœ… Both Cargo.toml and Cargo.lock updated
            - âœ… Build check passed for wasm32-unknown-unknown
            - âœ… All dependencies using latest stable versions
            - âœ… Version compatibility verified
            
            ### Build Tool Compatibility
            This update ensures:
            - Latest `wasm-bindgen-cli` matches `wasm-bindgen` version
            - Latest `worker-build` matches `worker` version
            - All sub-dependencies are compatible
            
            ### Next Steps
            1. Review the Cargo.toml and Cargo.lock changes
            2. Merge to apply latest stable versions
            3. Deployment workflow will auto-detect and use correct tool versions
            
            ---
            *Auto-generated by updater.yml workflow*  
            *Triggered by: @${{ github.actor }}*
          branch: chore/update-dependencies-${{ github.run_number }}
          base: beta
          labels: dependencies, stable, automated
          delete-branch: true
      
      - name: Success Summary
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "## âœ… Dependencies Successfully Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode:** ${{ inputs.update_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files:** Cargo.toml + Cargo.lock" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Versions" >> $GITHUB_STEP_SUMMARY
          echo "- wasm-bindgen: ${{ steps.versions.outputs.wasm_bindgen_toml_new }}" >> $GITHUB_STEP_SUMMARY
          echo "- worker: ${{ steps.versions.outputs.worker_toml_new }}" >> $GITHUB_STEP_SUMMARY
          echo "- wasm-bindgen-futures: ${{ steps.versions.outputs.wasm_futures_new }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pull request created" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build compatibility verified" >> $GITHUB_STEP_SUMMARY
      
      - name: No Changes Summary
        if: steps.changes.outputs.changed == 'false'
        run: |
          echo "## â„¹ï¸  Dependencies Already Up-to-Date" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No updates needed - all dependencies are already at latest stable versions." >> $GITHUB_STEP_SUMMARY
