name: Dependency Updater

# Updates dependencies to latest stable versions
# Ensures version consistency between Cargo.toml and Cargo.lock
# Auto-rollback on failure

on:
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    environment: cf
    
    steps:
      - name: Checkout beta branch
        uses: actions/checkout@v4
        with:
          ref: beta
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Install cargo-edit
        run: cargo install cargo-edit
      
      - name: Backup current files
        run: |
          cp Cargo.toml Cargo.toml.backup
          cp Cargo.lock Cargo.lock.backup
          echo "âœ… Backed up Cargo.toml and Cargo.lock"
      
      - name: Read current versions from Cargo.toml
        id: current_versions
        run: |
          echo "ðŸ“– Reading current versions from Cargo.toml..."
          
          # Extract versions from Cargo.toml
          WASM_BINDGEN_OLD=$(grep '^wasm-bindgen = ' Cargo.toml | grep -oP '"\K[^"]+' || echo "N/A")
          WORKER_OLD=$(grep '^worker = ' Cargo.toml | grep -oP '"\K[^"]+' || echo "N/A")
          WASM_FUTURES_OLD=$(grep '^wasm-bindgen-futures = ' Cargo.toml | grep -oP '"\K[^"]+' || echo "N/A")
          
          echo "wasm_bindgen_old=$WASM_BINDGEN_OLD" >> $GITHUB_OUTPUT
          echo "worker_old=$WORKER_OLD" >> $GITHUB_OUTPUT
          echo "wasm_futures_old=$WASM_FUTURES_OLD" >> $GITHUB_OUTPUT
          
          echo "Current versions in Cargo.toml:"
          echo "  - wasm-bindgen: $WASM_BINDGEN_OLD"
          echo "  - worker: $WORKER_OLD"
          echo "  - wasm-bindgen-futures: $WASM_FUTURES_OLD"
      
      - name: Update to latest stable versions
        id: update
        run: |
          echo "ðŸ”„ Updating to latest stable versions..."
          echo "================================"
          
          # Update all dependencies to latest stable versions
          echo "ðŸ“¦ Running cargo upgrade..."
          cargo upgrade
          
          echo "âœ… Cargo.toml updated to latest stable versions"
          
          # Regenerate Cargo.lock to match Cargo.toml
          echo ""
          echo "ðŸ”„ Regenerating Cargo.lock..."
          rm -f Cargo.lock
          cargo generate-lockfile
          cargo update
          
          echo "âœ… Cargo.lock regenerated with matching versions"
      
      - name: Extract new versions
        id: new_versions
        run: |
          echo "ðŸ“Š Reading new versions..."
          
          # Read from Cargo.toml (source of truth)
          WASM_BINDGEN_NEW=$(grep '^wasm-bindgen = ' Cargo.toml | grep -oP '"\K[^"]+' || echo "N/A")
          WORKER_NEW=$(grep '^worker = ' Cargo.toml | grep -oP '"\K[^"]+' || echo "N/A")
          WASM_FUTURES_NEW=$(grep '^wasm-bindgen-futures = ' Cargo.toml | grep -oP '"\K[^"]+' || echo "N/A")
          
          # Verify Cargo.lock matches
          WASM_BINDGEN_LOCK=$(grep -A 3 '\[\[package\]\]' Cargo.lock | grep -A 3 'name = "wasm-bindgen"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
          WORKER_LOCK=$(grep -A 3 '\[\[package\]\]' Cargo.lock | grep -A 3 'name = "worker"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
          
          echo "wasm_bindgen_new=$WASM_BINDGEN_NEW" >> $GITHUB_OUTPUT
          echo "worker_new=$WORKER_NEW" >> $GITHUB_OUTPUT
          echo "wasm_futures_new=$WASM_FUTURES_NEW" >> $GITHUB_OUTPUT
          echo "wasm_bindgen_lock=$WASM_BINDGEN_LOCK" >> $GITHUB_OUTPUT
          echo "worker_lock=$WORKER_LOCK" >> $GITHUB_OUTPUT
          
          echo "New versions:"
          echo "  Cargo.toml:"
          echo "    - wasm-bindgen: $WASM_BINDGEN_NEW"
          echo "    - worker: $WORKER_NEW"
          echo "    - wasm-bindgen-futures: $WASM_FUTURES_NEW"
          echo ""
          echo "  Cargo.lock (verification):"
          echo "    - wasm-bindgen: $WASM_BINDGEN_LOCK"
          echo "    - worker: $WORKER_LOCK"
          
          # Verify versions match
          if [ "$WASM_BINDGEN_NEW" != "$WASM_BINDGEN_LOCK" ]; then
            echo "âš ï¸  WARNING: wasm-bindgen version mismatch!"
            echo "  Cargo.toml: $WASM_BINDGEN_NEW"
            echo "  Cargo.lock: $WASM_BINDGEN_LOCK"
            exit 1
          fi
          
          if [ "$WORKER_NEW" != "$WORKER_LOCK" ]; then
            echo "âš ï¸  WARNING: worker version mismatch!"
            echo "  Cargo.toml: $WORKER_NEW"
            echo "  Cargo.lock: $WORKER_LOCK"
            exit 1
          fi
          
          echo "âœ… Version verification passed - Cargo.toml and Cargo.lock are in sync"
      
      - name: Test build compatibility
        id: build_test
        run: |
          echo "ðŸ”¨ Testing build with updated dependencies..."
          cargo check --target wasm32-unknown-unknown --release
          echo "âœ… Build check passed - all dependencies compatible"
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âŒ Update or build failed - Rolling back..."
          
          # Restore backups
          if [ -f Cargo.toml.backup ]; then
            cp Cargo.toml.backup Cargo.toml
            echo "âœ… Restored Cargo.toml from backup"
          fi
          
          if [ -f Cargo.lock.backup ]; then
            cp Cargo.lock.backup Cargo.lock
            echo "âœ… Restored Cargo.lock from backup"
          fi
          
          # Commit rollback
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if ! git diff --quiet; then
            git add Cargo.toml Cargo.lock
            git commit -m "chore: rollback failed dependency update"
            git push origin beta
            echo "âœ… Rollback committed and pushed to beta branch"
          else
            echo "â„¹ï¸  No changes to rollback"
          fi
          
          echo "## âŒ Dependency Update Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The dependency update process failed and has been automatically rolled back." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Restored Cargo.toml from backup" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Restored Cargo.lock from backup" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Changes reverted in beta branch" >> $GITHUB_STEP_SUMMARY
          
          exit 1
      
      - name: Check for changes
        id: changes
        run: |
          if ! git diff --exit-code Cargo.toml Cargo.lock; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Dependencies updated successfully"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes needed - dependencies already at latest stable"
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies to latest stable versions"
          title: "â¬†ï¸ Update: Latest stable dependencies [beta]"
          body: |
            ## â¬†ï¸ Dependency Updates - Latest Stable
            
            **Target Branch:** `beta`  
            **Update Strategy:** Stable releases only
            
            ### Version Changes
            
            | Package | Old Version | New Version |
            |---------|-------------|-------------|
            | **wasm-bindgen** | `${{ steps.current_versions.outputs.wasm_bindgen_old }}` | `${{ steps.new_versions.outputs.wasm_bindgen_new }}` |
            | **worker** | `${{ steps.current_versions.outputs.worker_old }}` | `${{ steps.new_versions.outputs.worker_new }}` |
            | **wasm-bindgen-futures** | `${{ steps.current_versions.outputs.wasm_futures_old }}` | `${{ steps.new_versions.outputs.wasm_futures_new }}` |
            
            ### Verification Status
            - âœ… Cargo.toml updated to latest stable versions
            - âœ… Cargo.lock regenerated with matching versions
            - âœ… Version consistency verified (Cargo.toml â†” Cargo.lock)
            - âœ… Build check passed for wasm32-unknown-unknown target
            - âœ… All dependencies compatible
            
            ### Version Matching
            ```
            Cargo.toml â†’ Cargo.lock
            wasm-bindgen: ${{ steps.new_versions.outputs.wasm_bindgen_new }} â†’ ${{ steps.new_versions.outputs.wasm_bindgen_lock }}
            worker: ${{ steps.new_versions.outputs.worker_new }} â†’ ${{ steps.new_versions.outputs.worker_lock }}
            ```
            
            ### Deployment Compatibility
            - Latest `wasm-bindgen-cli` will match `wasm-bindgen` version
            - Latest `worker-build` will match `worker` version
            - All sub-dependencies resolved to stable versions
            
            ### Next Steps
            1. Review the version changes
            2. Merge to apply latest stable dependencies
            3. Deployment workflow will auto-detect correct tool versions
            
            ---
            *Auto-generated by updater.yml workflow*  
            *Triggered by: @${{ github.actor }}*
          branch: chore/update-dependencies-${{ github.run_number }}
          base: beta
          labels: dependencies, stable, automated
          delete-branch: true
      
      - name: Success Summary
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "## âœ… Dependencies Successfully Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Update Strategy" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode:** Latest stable versions only" >> $GITHUB_STEP_SUMMARY
          echo "- **Source:** Cargo.toml (updated first)" >> $GITHUB_STEP_SUMMARY
          echo "- **Generated:** Cargo.lock (regenerated to match)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### New Versions" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| wasm-bindgen | ${{ steps.new_versions.outputs.wasm_bindgen_new }} |" >> $GITHUB_STEP_SUMMARY
          echo "| worker | ${{ steps.new_versions.outputs.worker_new }} |" >> $GITHUB_STEP_SUMMARY
          echo "| wasm-bindgen-futures | ${{ steps.new_versions.outputs.wasm_futures_new }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Version matching verified" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build compatibility confirmed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pull request created" >> $GITHUB_STEP_SUMMARY
      
      - name: No Changes Summary
        if: steps.changes.outputs.changed == 'false'
        run: |
          echo "## â„¹ï¸  Dependencies Already Up-to-Date" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependencies are already at latest stable versions." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Current Versions" >> $GITHUB_STEP_SUMMARY
          echo "- wasm-bindgen: ${{ steps.current_versions.outputs.wasm_bindgen_old }}" >> $GITHUB_STEP_SUMMARY
          echo "- worker: ${{ steps.current_versions.outputs.worker_old }}" >> $GITHUB_STEP_SUMMARY
          echo "- wasm-bindgen-futures: ${{ steps.current_versions.outputs.wasm_futures_old }}" >> $GITHUB_STEP_SUMMARY
