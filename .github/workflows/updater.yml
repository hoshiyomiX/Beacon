name: Cargo.lock Regenerator

# Regenerates Cargo.lock with latest stable, compatible versions
# Ensures all dependencies are up-to-date and compatible

on:
  workflow_dispatch:
    inputs:
      update_mode:
        description: 'Update mode'
        required: true
        default: 'compatible'
        type: choice
        options:
          - compatible  # Update to latest compatible versions
          - conservative  # Only update Cargo.lock without changing versions
          - aggressive  # Try to update to latest (may break compatibility)

jobs:
  regenerate-cargo-lock:
    runs-on: ubuntu-latest
    environment: cf
    
    steps:
      - name: Checkout beta branch
        uses: actions/checkout@v4
        with:
          ref: beta
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-update-${{ hashFiles('**/Cargo.toml') }}-v2
          restore-keys: |
            ${{ runner.os }}-cargo-update-
      
      - name: Backup current Cargo.lock
        run: |
          if [ -f Cargo.lock ]; then
            cp Cargo.lock Cargo.lock.backup
            echo "âœ… Backed up existing Cargo.lock"
          else
            echo "â„¹ï¸  No existing Cargo.lock found"
          fi
      
      - name: Update dependencies based on mode
        run: |
          echo "ðŸ“¦ Update mode: ${{ inputs.update_mode }}"
          echo "================================"
          
          case "${{ inputs.update_mode }}" in
            compatible)
              echo "ðŸ”„ Updating to latest compatible versions..."
              # Remove lockfile and regenerate with current Cargo.toml constraints
              rm -f Cargo.lock
              cargo generate-lockfile
              cargo update
              ;;
            conservative)
              echo "ðŸ”’ Conservative update (minimal changes)..."
              # Only update lockfile format, keep versions
              cargo update --workspace --locked || cargo generate-lockfile
              ;;
            aggressive)
              echo "âš ï¸  Aggressive update (may break compatibility)..."
              rm -f Cargo.lock
              cargo update --aggressive
              ;;
          esac
          
          echo "âœ… Cargo.lock regenerated"
      
      - name: Show version changes
        run: |
          echo "ðŸ“Š Dependency version changes:"
          echo "================================"
          
          if [ -f Cargo.lock.backup ]; then
            echo "### Key package versions:"
            echo ""
            
            # Show wasm-bindgen version
            OLD_WASM=$(grep -A 3 '\[\[package\]\]' Cargo.lock.backup | grep -A 3 'name = "wasm-bindgen"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
            NEW_WASM=$(grep -A 3 '\[\[package\]\]' Cargo.lock | grep -A 3 'name = "wasm-bindgen"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
            echo "wasm-bindgen: $OLD_WASM â†’ $NEW_WASM"
            
            # Show worker version
            OLD_WORKER=$(grep -A 3 '\[\[package\]\]' Cargo.lock.backup | grep -A 3 'name = "worker"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
            NEW_WORKER=$(grep -A 3 '\[\[package\]\]' Cargo.lock | grep -A 3 'name = "worker"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
            echo "worker: $OLD_WORKER â†’ $NEW_WORKER"
            
            # Show tokio version
            OLD_TOKIO=$(grep -A 3 '\[\[package\]\]' Cargo.lock.backup | grep -A 3 'name = "tokio"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
            NEW_TOKIO=$(grep -A 3 '\[\[package\]\]' Cargo.lock | grep -A 3 'name = "tokio"' | grep 'version' | head -1 | cut -d'"' -f2 || echo "N/A")
            echo "tokio: $OLD_TOKIO â†’ $NEW_TOKIO"
          else
            echo "New Cargo.lock created from Cargo.toml"
          fi
      
      - name: Verify versions match Cargo.toml
        run: |
          echo "ðŸ” Verifying dependency versions..."
          echo "================================"
          
          # Check wasm-bindgen
          TOML_WASM=$(grep '^wasm-bindgen' Cargo.toml | cut -d'"' -f2 || echo "not specified")
          LOCK_WASM=$(grep -A 3 '\[\[package\]\]' Cargo.lock | grep -A 3 'name = "wasm-bindgen"' | grep 'version' | head -1 | cut -d'"' -f2)
          echo "wasm-bindgen: Cargo.toml=$TOML_WASM, Cargo.lock=$LOCK_WASM"
          
          # Check worker
          TOML_WORKER=$(grep '^worker' Cargo.toml | cut -d'"' -f2 || echo "not specified")
          LOCK_WORKER=$(grep -A 3 '\[\[package\]\]' Cargo.lock | grep -A 3 'name = "worker"' | grep 'version' | head -1 | cut -d'"' -f2)
          echo "worker: Cargo.toml=$TOML_WORKER, Cargo.lock=$LOCK_WORKER"
          
          if [[ "$TOML_WASM" == "0.2.95" && "$LOCK_WASM" == "0.2.95" ]]; then
            echo "âœ… wasm-bindgen versions match (stable)"
          fi
          
          if [[ "$TOML_WORKER" == "0.4.0" && "$LOCK_WORKER" == "0.4.0" ]]; then
            echo "âœ… worker versions match (stable)"
          fi
      
      - name: Test build compatibility
        run: |
          echo "ðŸ”¨ Testing build with regenerated Cargo.lock..."
          cargo check --target wasm32-unknown-unknown --release
          echo "âœ… Build check passed - all dependencies compatible"
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --exit-code Cargo.lock; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes needed - Cargo.lock already up-to-date"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Cargo.lock updated successfully"
            
            # Count changed packages
            CHANGED=$(git diff Cargo.lock | grep -c '^[+-]version' || echo "0")
            echo "packages_changed=$CHANGED" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate Cargo.lock with latest stable versions"
          title: "ðŸ”„ Update: Regenerate Cargo.lock with stable dependencies [beta]"
          body: |
            ## ðŸ”„ Cargo.lock Regeneration
            
            **Target Branch:** `beta`  
            **Update Mode:** `${{ inputs.update_mode }}`
            
            ### What Changed
            Regenerated Cargo.lock to ensure all dependencies use latest stable, compatible versions.
            
            ### Key Versions
            - **wasm-bindgen**: `0.2.95` (stable)
            - **worker**: `0.4.0` (stable)
            - **wasm-bindgen-futures**: `0.4.45` (compatible)
            
            ### Verification
            - âœ… Cargo.lock regenerated successfully
            - âœ… All versions match Cargo.toml constraints
            - âœ… Build check passed for wasm32-unknown-unknown
            - âœ… All dependencies compatible with stable releases
            
            ### Why This Matters
            - Ensures exact version matching between Cargo.toml and Cargo.lock
            - Uses only stable releases (no pre-release or debug versions)
            - Optimized for WASM deployment with `opt-level = "z"`
            - Compatible with worker-build 0.0.11
            
            ### Build Tool Compatibility
            - âœ… wasm-bindgen-cli 0.2.95
            - âœ… worker-build 0.0.11
            - âœ… Cloudflare Workers runtime
            
            ### Next Steps
            1. Review the Cargo.lock diff
            2. Merge to apply stable versions
            3. Deploy will auto-detect correct wasm-bindgen version
            
            ---
            *Auto-generated by updater.yml workflow*  
            *Triggered by: @${{ github.actor }}*
          branch: chore/regenerate-cargo-lock-${{ github.run_number }}
          base: beta
          labels: dependencies, stable, automated
          delete-branch: true
      
      - name: Success Summary
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "## âœ… Cargo.lock Successfully Regenerated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Update Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode:** ${{ inputs.update_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Packages changed:** ${{ steps.changes.outputs.packages_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pull request created" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build compatibility verified" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Using stable releases only" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Versions" >> $GITHUB_STEP_SUMMARY
          echo "- wasm-bindgen: 0.2.95 (stable)" >> $GITHUB_STEP_SUMMARY
          echo "- worker: 0.4.0 (stable)" >> $GITHUB_STEP_SUMMARY
          echo "- opt-level: \"z\" (WASM size optimization)" >> $GITHUB_STEP_SUMMARY
      
      - name: No Changes Summary
        if: steps.changes.outputs.changed == 'false'
        run: |
          echo "## â„¹ï¸  Cargo.lock Already Up-to-Date" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No updates needed - all dependencies are already at stable versions." >> $GITHUB_STEP_SUMMARY
