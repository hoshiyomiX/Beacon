name: Update Cargo.lock

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get current branch
        id: branch
        run: echo "name=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Backup Cargo.lock
        run: |
          if [ -f Cargo.lock ]; then
            cp Cargo.lock Cargo.lock.backup
          fi

      - name: Update dependencies
        run: cargo update

      - name: Check for changes
        id: changes
        run: |
          if [ -f Cargo.lock.backup ]; then
            if diff -q Cargo.lock Cargo.lock.backup; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Verify build
        if: steps.changes.outputs.has_changes == 'true'
        run: cargo check --target wasm32-unknown-unknown

      - name: Show wasm-bindgen version
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "Updated wasm-bindgen versions:"
          grep -A 1 '"wasm-bindgen"' Cargo.lock | grep version | head -5

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.lock
          git commit -m "chore: update Cargo.lock

Auto-updated dependencies on ${{ steps.branch.outputs.name }}
Build verified: ✅"
          git push

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
            echo "✅ Cargo.lock updated on ${{ steps.branch.outputs.name }}"
          else
            echo "ℹ️  No updates needed"
          fi
