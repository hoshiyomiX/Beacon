name: cf workers

on:
  workflow_dispatch:

  push:
    branches:
      - '**'  # Trigger on all branches
    paths-ignore:
      - 'README.md'
      - 'LICENSE.md'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: cf
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust with caching
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      # Enhanced Rust caching with Swatinem action
      - name: Cache Rust dependencies and build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "beacon-wasm"
          cache-on-failure: true
          save-if: true  # Auto-save cache for all branches

      # Cache build tools separately (rarely change)
      - name: Cache build tools
        uses: actions/cache@v4
        id: tools-cache
        with:
          path: |
            ~/.cargo/bin/wasm-bindgen
            ~/.cargo/bin/worker-build
            /usr/local/bin/wasm-opt
          key: ${{ runner.os }}-build-tools-v6-wasm-bindgen-0.2.106-worker-build-0.7.0-binaryen-119

      # Install build tools only if not cached
      - name: Install build tools
        if: steps.tools-cache.outputs.cache-hit != 'true'
        run: |
          cargo install wasm-bindgen-cli --version 0.2.106 --locked
          cargo install worker-build --version 0.7.0 --locked
          # Install binaryen (provides wasm-opt)
          sudo apt-get update
          sudo apt-get install -y binaryen

      # Check if Rust code changed to skip unnecessary rebuilds
      - name: Check for code changes
        id: changes
        run: |
          git fetch origin ${{ github.event.before }} --depth=1 2>/dev/null || true
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null | grep -qE '\.(rs|toml)$'; then
            echo "rust_changed=true" >> $GITHUB_OUTPUT
          else
            echo "rust_changed=false" >> $GITHUB_OUTPUT
          fi

      # Cache the built worker artifact
      - name: Cache built worker
        if: steps.changes.outputs.rust_changed == 'false'
        uses: actions/cache@v4
        id: worker-cache
        with:
          path: build/
          key: ${{ runner.os }}-worker-${{ hashFiles('Cargo.lock', 'src/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-worker-

      # Build only if code changed or cache miss
      - name: Build worker
        if: steps.changes.outputs.rust_changed == 'true' || steps.worker-cache.outputs.cache-hit != 'true'
        run: |
          worker-build --release
        env:
          CARGO_INCREMENTAL: 1
          CARGO_TERM_COLOR: always

      # Post-process WASM with wasm-opt for additional size reduction
      - name: Optimize WASM with wasm-opt
        if: steps.changes.outputs.rust_changed == 'true' || steps.worker-cache.outputs.cache-hit != 'true'
        run: |
          echo "Running wasm-opt for additional size optimization..."
          for wasm_file in build/**/*.wasm; do
            if [ -f "$wasm_file" ]; then
              original_size=$(stat --format=%s "$wasm_file" 2>/dev/null || stat -c%s "$wasm_file")
              echo "Optimizing: $wasm_file (size: $original_size bytes)"
              wasm-opt -Oz "$wasm_file" -o "${wasm_file}.opt"
              mv "${wasm_file}.opt" "$wasm_file"
              optimized_size=$(stat --format=%s "$wasm_file" 2>/dev/null || stat -c%s "$wasm_file")
              reduction=$((original_size - optimized_size))
              percent=$((reduction * 100 / original_size))
              echo "âœ“ Optimized to $optimized_size bytes (saved $reduction bytes, $percent% reduction)"
            fi
          done

      # Deploy with optimized settings
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          wranglerVersion: '3.90.0'
          # Pass secrets as environment variables if needed
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # Save build artifacts for potential rollback
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: worker-build-${{ github.sha }}
          path: build/
          retention-days: 7
          compression-level: 9