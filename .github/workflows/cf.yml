name: cf workers

on:
  workflow_dispatch:

  push:
    branches:
      - master
      - debug
      - alpha
      - beta
      - test
    paths-ignore:
      - 'README.md'
      - 'LICENSE.md'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: cf
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      # Enhanced Rust caching with Swatinem action
      - name: Cache Rust dependencies and build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "beacon-wasm"
          cache-on-failure: true
          save-if: ${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/test' }}

      # Cache build tools separately (rarely change)
      - name: Cache build tools
        uses: actions/cache@v4
        id: tools-cache
        with:
          path: |
            ~/.cargo/bin/wasm-bindgen
            ~/.cargo/bin/worker-build
          key: ${{ runner.os }}-build-tools-v3-wasm-bindgen-0.2.105-worker-build-0.7.0

      # Install build tools only if not cached
      - name: Install build tools
        if: steps.tools-cache.outputs.cache-hit != 'true'
        run: |
          cargo install wasm-bindgen-cli --version 0.2.105 --locked
          cargo install worker-build --version 0.7.0 --locked

      # Check if Rust code changed to skip unnecessary rebuilds
      - name: Check for code changes
        id: changes
        run: |
          # Handle first push, force-push, or null commits
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ] || [ -z "${{ github.event.before }}" ]; then
            echo "First push or force-push detected, building from scratch"
            echo "rust_changed=true" >> $GITHUB_OUTPUT
          else
            git fetch origin ${{ github.event.before }} --depth=1 2>/dev/null || true
            if git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null | grep -qE '\.(rs|toml)$'; then
              echo "Rust code changes detected"
              echo "rust_changed=true" >> $GITHUB_OUTPUT
            else
              echo "No Rust code changes detected"
              echo "rust_changed=false" >> $GITHUB_OUTPUT
            fi
          fi
          echo "âœ… wasm-bindgen: $(wasm-bindgen --version)"

      # Cache the built worker artifact with improved key
      - name: Cache built worker
        if: steps.changes.outputs.rust_changed == 'false'
        uses: actions/cache@v4
        id: worker-cache
        with:
          path: build/
          key: ${{ runner.os }}-worker-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml', 'src/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-worker-

      # Build only if code changed or cache miss
      - name: Build worker
        if: steps.changes.outputs.rust_changed == 'true' || steps.worker-cache.outputs.cache-hit != 'true'
        run: |
          echo "Building worker..."
          worker-build --release
        env:
          CARGO_INCREMENTAL: 1

      - name: Run wasm-bindgen
        run: |
          echo "=== Running wasm-bindgen ==="
          mkdir -p build/worker
          wasm-bindgen --target bundler --out-dir ./build/worker ./target/wasm32-unknown-unknown/release/beacon.wasm
          
          # Create shim.mjs to export the worker
          cat > build/worker/shim.mjs << 'EOF'
          import * as beacon from './beacon.js';
          export default beacon;
          EOF

      # Deploy with optimized settings
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          wranglerVersion: '4.51.0'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # Save build artifacts for potential rollback
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: worker-build-${{ github.sha }}
          path: build/
          retention-days: 7
          compression-level: 9