name: cf workers

on:
  workflow_dispatch:

  push:
    branches:
      - master
      - debug
      - testing
    paths-ignore:
      - 'README.md'
      - 'LICENSE.md'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: cf
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Clean build artifacts and cache
        run: |
          echo "Running cargo clean to ensure fresh build"
          cargo clean
          echo "Removing cached worker-build to force latest version"
          rm -rf ~/.cargo/bin/worker-build || true
          rm -rf ~/.cargo/bin/wasm-bindgen || true
          rm -rf build/ || true
          echo "Cleanup completed"

      - name: Install wasm-bindgen-cli 0.2.106
        run: |
          cargo install -f wasm-bindgen-cli --version 0.2.106
          wasm-bindgen --version

      - name: Install worker-build (latest from git)
        run: |
          echo "Installing latest worker-build with wasm-bindgen 0.2.106 support"
          echo "Note: Template parsing errors and patch warnings from worker-build are expected and harmless"
          cargo install --git https://github.com/cloudflare/workers-rs --force worker-build 2>&1 | \
            grep -v "invalid character" | \
            grep -v "missing key for inline table" | \
            grep -v "Patch.*was not used in the crate graph" | \
            grep -v "Check that the patched package" | \
            grep -v "what is locked in the Cargo.lock" | \
            grep -v "This may also occur with an optional" || true
          worker-build --version || echo "worker-build version command not available"
          echo "✅ worker-build installed successfully"

      - name: Update Cargo.lock to resolve wasm-bindgen patches
        run: |
          echo "Updating Cargo.lock to sync with wasm-bindgen 0.2.106"
          cargo update -p wasm-bindgen -p wasm-bindgen-futures
          echo "Cargo.lock updated"

      - name: Install WASM verification tools
        run: |
          echo "Installing wasm-tools for advanced WASM verification"
          cargo install wasm-tools
          wasm-tools --version

      - name: Build WASM
        run: |
          echo "Building with wasm-bindgen 0.2.106 (pinned in Cargo.toml)"
          worker-build --release

      - name: Verify WASM compilation integrity
        run: |
          echo "=== WASM COMPILATION VERIFICATION ==="
          
          # Check if build directory exists
          if [ ! -d "build" ]; then
            echo "❌ Error: build/ directory not found"
            exit 1
          fi
          echo "✅ build/ directory found"
          
          # Find all WASM files
          WASM_FILES=$(find build -name "*.wasm" -type f)
          if [ -z "$WASM_FILES" ]; then
            echo "❌ Error: No WASM files found in build/"
            echo "Contents of build/:"
            ls -la build/
            exit 1
          fi
          echo "Found WASM files:"
          echo "$WASM_FILES"
          
          # Validate each WASM file
          for wasm_file in $WASM_FILES; do
            echo ""
            echo "--- Validating $wasm_file ---"
            
            # Check file exists and has content
            if [ ! -s "$wasm_file" ]; then
              echo "❌ Error: $wasm_file is empty or missing"
              exit 1
            fi
            
            WASM_SIZE=$(stat -c%s "$wasm_file" 2>/dev/null || stat -f%z "$wasm_file")
            WASM_SIZE_MB=$(echo "scale=2; $WASM_SIZE / 1024 / 1024" | bc)
            echo "✅ File size: ${WASM_SIZE} bytes (${WASM_SIZE_MB} MB)"
            
            # WASM magic number validation (0061 736D = \0asm)
            MAGIC=$(xxd -l 4 -p "$wasm_file")
            if [ "$MAGIC" != "0061736d" ]; then
              echo "❌ Error: Invalid WASM magic number: $MAGIC (expected: 0061736d)"
              exit 1
            fi
            echo "✅ WASM magic number: $MAGIC ✓"
            
            # WASM version check (version field at bytes 4-7, should be 0x00000001)
            VERSION=$(xxd -s 4 -l 4 -p "$wasm_file")
            if [ "$VERSION" != "01000000" ]; then
              echo "⚠️  Warning: WASM version $VERSION (expected: 01000000)"
            else
              echo "✅ WASM version: $VERSION ✓"
            fi
            
            # Check file is not truncated (minimum viable WASM ~4KB)
            if [ "$WASM_SIZE" -lt 4096 ]; then
              echo "⚠️  Warning: WASM unusually small (${WASM_SIZE} bytes)"
            fi
            
            # Cloudflare Workers size limits
            if [ "$WASM_SIZE" -gt 10485760 ]; then
              echo "❌ Error: WASM exceeds 10MB Workers limit"
              exit 1
            elif [ "$WASM_SIZE" -gt 1048576 ]; then
              echo "⚠️  Warning: WASM exceeds 1MB (free tier limit, OK for paid)"
            fi
            
            echo "✅ $wasm_file is VALID and NOT CORRUPT ✓"
          done
          
          echo ""
          echo "=== WASM FILES VERIFIED SUCCESSFULLY ==="

      - name: Advanced WASM verification with wasm-tools
        run: |
          echo "=== ADVANCED WASM VERIFICATION ==="
          
          # Find main WASM file
          WASM_FILE=""
          if [ -f "build/index_bg.wasm" ]; then
            WASM_FILE="build/index_bg.wasm"
          elif [ -f "build/worker/index_bg.wasm" ]; then
            WASM_FILE="build/worker/index_bg.wasm"
          elif [ -f "build/index.wasm" ]; then
            WASM_FILE="build/index.wasm"
          else
            echo "⚠️  Could not find main WASM file for deep inspection"
            exit 0
          fi
          
          echo "Analyzing: $WASM_FILE"
          echo ""
          
          # 1. Validate WASM structure
          echo "[1] WASM Format Validation"
          if wasm-tools validate "$WASM_FILE" 2>&1; then
            echo "✅ WASM format is structurally valid"
          else
            echo "❌ WASM validation failed - file may be corrupted"
            exit 1
          fi
          echo ""
          
          # 2. Dump WASM sections
          echo "[2] WASM Module Sections"
          if wasm-tools objdump "$WASM_FILE" -h 2>/dev/null; then
            echo "✅ Successfully inspected WASM sections"
          else
            echo "⚠️  Could not inspect sections"
          fi
          echo ""
          
          # 3. Check exports
          echo "[3] WASM Exports (Entry Points)"
          EXPORTS=$(wasm-tools objdump "$WASM_FILE" -x 2>/dev/null | grep -E "export|Export" | head -20 || echo "")
          if [ -n "$EXPORTS" ]; then
            echo "$EXPORTS"
            EXPORT_COUNT=$(echo "$EXPORTS" | wc -l)
            echo "✅ Found ${EXPORT_COUNT} exports"
          else
            echo "⚠️  No exports found"
          fi
          echo ""
          
          # 4. Check imports
          echo "[4] WASM Imports (Dependencies)"
          IMPORTS=$(wasm-tools objdump "$WASM_FILE" -x 2>/dev/null | grep -E "import|Import" | head -20 || echo "")
          if [ -n "$IMPORTS" ]; then
            IMPORT_COUNT=$(echo "$IMPORTS" | wc -l)
            echo "First 20 imports:"
            echo "$IMPORTS"
            echo "✅ Found ${IMPORT_COUNT} imports"
          else
            echo "ℹ️  No imports found"
          fi
          echo ""
          
          # 5. Function analysis
          echo "[5] WASM Function Count"
          FUNC_COUNT=$(wasm-tools objdump "$WASM_FILE" -x 2>/dev/null | grep -c "func" || echo "0")
          echo "Total functions: ${FUNC_COUNT}"
          if [ "$FUNC_COUNT" -gt 10 ]; then
            echo "✅ Reasonable function count"
          else
            echo "⚠️  Low function count (may indicate build issue)"
          fi
          echo ""
          
          # 6. Memory configuration
          echo "[6] WASM Memory Configuration"
          MEMORY_INFO=$(wasm-tools objdump "$WASM_FILE" -x 2>/dev/null | grep -A 3 -E "Memory|memory" || echo "")
          if [ -n "$MEMORY_INFO" ]; then
            echo "$MEMORY_INFO"
            echo "✅ Memory configuration found"
          else
            echo "ℹ️  Memory configuration not extracted"
          fi
          echo ""
          
          # 7. Print first 50 lines of WAT disassembly
          echo "[7] WASM Disassembly Preview (first 50 lines)"
          if wasm-tools print "$WASM_FILE" 2>/dev/null | head -50; then
            echo "✅ Successfully disassembled to WAT format"
          else
            echo "⚠️  Could not disassemble"
          fi
          echo ""
          
          echo "=== ADVANCED VERIFICATION COMPLETE ==="
          echo "✅ WASM module is valid and ready for deployment"

      - name: Inspect workspace structure
        run: |
          echo "=== Workspace Structure ==="
          echo "Root directory:"
          ls -lah
          echo ""
          echo "Build directory tree:"
          if [ -d "build" ]; then
            find build -type f -exec ls -lh {} \;
          else
            echo "⚠️  build/ directory not found"
          fi
          echo ""
          echo "Searching for WASM artifacts in entire workspace:"
          find . -name "*.wasm" -o -name "*.mjs" -o -name "shim.mjs" | head -20

      - name: Verify build artifacts
        run: |
          echo "=== Build Artifact Validation ==="
          
          # Check if build/worker directory exists (worker-build output location)
          if [ ! -d "build/worker" ]; then
            echo "❌ Error: build/worker/ directory not found"
            echo "worker-build may have failed or output to unexpected location"
            exit 1
          fi
          echo "✅ build/worker/ directory found"
          
          # Check for shim.mjs (main entry point)
          if [ ! -f "build/worker/shim.mjs" ]; then
            echo "❌ Error: build/worker/shim.mjs not found"
            exit 1
          fi
          SHIM_SIZE=$(stat -c%s "build/worker/shim.mjs" 2>/dev/null || stat -f%z "build/worker/shim.mjs")
          echo "✅ shim.mjs found (${SHIM_SIZE} bytes)"
          
          # List all files in build/ for verification
          echo ""
          echo "=== Contents of build/ ==="
          ls -lh build/
          echo ""
          echo "=== Contents of build/worker/ ==="
          ls -lh build/worker/
          
          echo ""
          echo "=== All build artifacts validated successfully ==="

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
