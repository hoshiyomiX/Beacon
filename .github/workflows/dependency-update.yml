name: Dependency Update & Compatibility Check

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    environment: cf
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: beta
      
      - name: Setup Rust with caching
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-deps-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-deps-
      
      - name: Install cargo-edit
        run: |
          if ! command -v cargo-upgrade &> /dev/null; then
            cargo install cargo-edit
          fi
      
      - name: Update dependencies
        run: |
          cargo update
          cargo upgrade --compatible
        continue-on-error: false
      
      - name: Install build tools (cached)
        run: |
          if ! command -v wasm-bindgen &> /dev/null; then
            WASM_BINDGEN_VERSION=$(cargo metadata --format-version=1 --no-deps | jq -r '.packages[] | select(.name == "wasm-bindgen") | .version')
            cargo install -f wasm-bindgen-cli --version $WASM_BINDGEN_VERSION
          fi
          if ! command -v worker-build &> /dev/null; then
            cargo install -q worker-build --version 0.7.0
          fi
      
      - name: Build compatibility test
        run: |
          cargo check --all-features
          worker-build --release
        continue-on-error: false
      
      - name: Security audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit
          fi
          cargo audit || true
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --exit-code Cargo.toml Cargo.lock; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update compatible dependencies"
          title: "ğŸ”„ Dependency Update - Beta"
          body: |
            ## ğŸ“¦ Dependency Update Report
            
            Automated dependency update targeting **beta** branch.
            
            ### âœ… Verification Passed
            - Updated to latest compatible versions
            - Build test completed successfully
            - wasm32-unknown-unknown target verified
            - worker-build compilation passed
            
            ### ğŸ” Next Steps
            1. Review Cargo.lock changes
            2. Merge to beta for testing
            3. Monitor deployment logs
            
            ---
            *Auto-generated by dependency-update workflow*
          branch: deps/auto-update-${{ github.run_number }}
          base: beta
          labels: dependencies, automated, beta
