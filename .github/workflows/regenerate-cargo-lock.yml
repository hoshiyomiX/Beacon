name: Regenerate Cargo Lock (PR Workflow)

on:
  workflow_dispatch: # Manual trigger from Actions tab
    inputs:
      target_branch:
        description: 'Branch to create PR against'
        required: true
        default: 'beta'
        type: choice
        options:
        - beta
        - main

jobs:
  update-lockfile:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # 1. Load latest files from repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch || 'beta' }}
          fetch-depth: 0

      # 2. Setup Rust environment
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      # 3. Backup original Cargo.lock
      - name: Backup original Cargo.lock
        run: |
          if [ -f Cargo.lock ]; then
            cp Cargo.lock Cargo.lock.bak
            echo "âœ… Original Cargo.lock backed up as Cargo.lock.bak"
            echo "ðŸ“Š Original lockfile size: $(wc -l < Cargo.lock) lines"
          else
            echo "âš ï¸ No Cargo.lock found to backup"
          fi

      # 4. Execute cargo update
      - name: Update dependencies
        run: |
          echo "ðŸ”„ Running cargo update..."
          cargo update
          
          # Show what changed
          if [ -f Cargo.lock.bak ]; then
            echo "ðŸ“ˆ Dependency changes detected:"
            diff -u Cargo.lock.bak Cargo.lock | head -50 || true
          fi

      # 5. Verify build (prevent deploy errors)
      - name: Verify build integrity
        run: |
          echo "ðŸ›¡ï¸ Running cargo check to ensure no breaking changes..."
          if cargo check --locked; then
            echo "âœ… Build verification passed!"
          else
            echo "âŒ Build failed! Rolling back..."
            mv Cargo.lock.bak Cargo.lock
            exit 1
          fi

      # 6. Create feature branch for PR
      - name: Create feature branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          BRANCH_NAME="chore/regen-cargo-lock-$(date +%Y%m%d-%H%M%S)-$(github.run_id)"
          git checkout -b "$BRANCH_NAME"
          
          # Clean up backup
          rm -f Cargo.lock.bak
          
          # Commit changes
          git add Cargo.lock
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "chore: regenerate Cargo.lock

Auto-generated by GitHub Actions workflow

Changes:
- Updated all dependencies to latest compatible versions
- Verified build integrity with cargo check
- Ready for review and merge"
            
            echo "âœ… Changes committed to branch: $BRANCH_NAME"
          fi

      # 7. Push branch and create PR
      - name: Push branch and create PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate Cargo.lock"
          title: "chore: Update Cargo.lock to latest dependencies"
          body: |
            ## Automated Cargo.lock Regeneration
            
            This PR was automatically generated by the Cargo lockfile update workflow.
            
            ### Changes Made:
            - ðŸ”„ Ran `cargo update` to refresh all dependencies
            - âœ… Verified build with `cargo check --locked` (no breaking changes)
            - ðŸ“¦ Backup of original lockfile created and verified
            
            ### Why This Matters:
            - Keeps dependencies secure and up-to-date
            - Prevents version drift between environments
            - Maintains build compatibility
            
            **Status:** Ready for review and merge
            
            ---
            
            *Generated by GitHub Actions on ${{ github.event.inputs.target_branch || 'beta' }} branch*
          base: ${{ github.event.inputs.target_branch || 'beta' }}
          branch: chore/regen-cargo-lock-${{ github.run_id }}
          delete-branch: true
          labels: |
            automated
            dependencies
            safe-to-merge
          assignees: hoshiyomiX
          reviewers: hoshiyomiX
          
