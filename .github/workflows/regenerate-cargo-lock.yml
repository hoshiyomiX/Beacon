name: Regenerate Cargo Lock

on:
  workflow_dispatch:

jobs:
  update-lockfile:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1. Load latest files from repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: beta

      # 2. Setup Rust
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      # 3. Backup & Update
      - name: Update Dependencies
        id: update
        run: |
          # Backup
          cp Cargo.lock Cargo.lock.bak
          
          # Update
          echo "üîÑ Running cargo update..."
          cargo update
          
          # Safety Check: Verify dependencies match and project builds
          echo "üõ°Ô∏è Verifying build health..."
          if cargo check; then
            echo "‚úÖ Check passed."
            rm Cargo.lock.bak # Clean up backup only if successful
          else
            echo "‚ùå Dependency check failed! Rolling back..."
            mv Cargo.lock.bak Cargo.lock
            exit 1
          fi

      # 4. Create Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate Cargo.lock"
          title: "chore: Update Cargo.lock dependencies"
          body: |
            This PR regenerates `Cargo.lock` to the latest compatible versions.
            
            **Automated Workflow:**
            1. Checked out `beta`
            2. Backed up `Cargo.lock`
            3. Ran `cargo update`
            4. Ran `cargo check` to ensure no immediate build errors
            
            Please review the changes before merging to avoid deploy errors.
          branch: chore/update-cargo-lock
          base: beta
          delete-branch: true
