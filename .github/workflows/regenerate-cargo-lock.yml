name: Regenerate Cargo Lock

on:
  workflow_dispatch:

jobs:
  update-lockfile:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: beta
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Check and regenerate Cargo.lock
        id: update
        run: |
          if [ -f Cargo.lock ]; then
            echo "üì¶ Backing up existing Cargo.lock..."
            cp Cargo.lock Cargo.lock.bak
            rm Cargo.lock
          else
            echo "‚ö†Ô∏è  Cargo.lock missing - will generate new one"
          fi
          
          echo "üîÑ Generating Cargo.lock..."
          cargo generate-lockfile
          
          echo "üõ°Ô∏è  Verifying build..."
          if cargo check; then
            echo "‚úÖ Build verification passed"
            rm -f Cargo.lock.bak
          else
            echo "‚ùå Build failed! Rolling back..."
            if [ -f Cargo.lock.bak ]; then
              mv Cargo.lock.bak Cargo.lock
            else
              rm -f Cargo.lock
            fi
            exit 1
          fi

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -f Cargo.lock ]; then
            git add Cargo.lock
            
            if ! git diff --cached --quiet; then
              git commit -m "chore: Regenerate Cargo.lock

Generated fresh Cargo.lock from Cargo.toml
Build verification: ‚úÖ PASSED"
              git push origin beta
              echo "‚úÖ Cargo.lock committed to beta"
            else
              echo "‚ÑπÔ∏è  No changes to commit"
            fi
          fi
