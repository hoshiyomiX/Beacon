name: Regenerate Cargo Lock

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-lockfile:
    runs-on: ubuntu-latest
    steps:
      # 1. Load latest files from repo (beta branch)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: beta

      # 2. Setup Rust
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      # 3. Backup & Execute Update
      - name: Update and Verify
        id: update
        run: |
          # Backup original
          cp Cargo.lock Cargo.lock.bak
          
          echo "üîÑ Executing cargo update..."
          cargo update

          # Check if file actually changed
          if git diff --quiet Cargo.lock; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No dependency updates available. Cleaning up..."
            rm Cargo.lock.bak
            exit 0
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

          # Verify Dependency Health (Avoid deploy error)
          echo "üõ°Ô∏è Verifying build health..."
          if cargo check --locked; then
            echo "‚úÖ Build verification passed."
            rm Cargo.lock.bak
          else
            echo "‚ùå Dependency check failed! Rolling back..."
            mv Cargo.lock.bak Cargo.lock
            exit 1
          fi

      # 4. Create Pull Request (Only if changes exist)
      - name: Create Pull Request
        if: steps.update.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update Cargo.lock"
          title: "chore: Update Cargo.lock"
          body: |
            Automated update of `Cargo.lock`.
            
            - Ran `cargo update`
            - Verified via `cargo check`
          branch: chore/update-cargo-lock
          base: beta
          delete-branch: true
